# Viv

<!-- PROJECT DEMO -->
<div align="center">
  <a href="https://github.com/daylinmorgan/viv">
    <img src="https://raw.githubusercontent.com/daylinmorgan/viv/main/docs/demo.gif" alt="Logo" width=600 >
  </a>
  <p align="center">
  viv isn't venv
  </p>
</div>
<br />

See [usage](https://github.com/daylinmorgan/viv/blob/main/docs/usage.md) for more demo gifs.

## Setup

### Manual (Recommended)

Start by cloning the repo and symlinking the script for access to the CLI.
By default it will symlink `./src/viv/viv.py` to `~/bin/viv`.
You can set `PREFIX` to symlink to a different location.

```sh
git clone git@github.com:daylinmorgan/viv.git ~/.viv
cd ~/.viv
make install # or PREFIX=~/.local/bin make install
```

Place this directory on the python path in your rc file.

```sh
export PYTHONPATH="$PYTHONPATH:$HOME/.viv/src"
```

### Pypi (Not Recommended)

```sh
pip install viv
```

## Usage

Then in any python script with external dependencies you can add this line,
to automate env creation and installation of dependencies.

```python
__import__("viv").activate("click")
```

To remove all `vivenvs`:
```sh
viv remove $(viv list -q)
```

## Standalone Function

The below function can be freely pasted at the top of your scripts and requires
no modification of your PYTHONPATH or import of additional modules.

It can be auto-generated with for example: `viv freeze rich --standalone`.

The only part necessary to modify if copied verbatim from here is the call to `_viv_activate`.

```python
# <<<<< auto-generated by daylinmorgan/viv (v.22.12a3)
# fmt: off
def _viv_activate(*pkgs: str, track_exe: bool = False, name: str = "") -> None:                             # noqa
    i,s,m,e,spec=__import__,str,map,lambda x: True if x else False, [*pkgs]                                 # noqa
    if not {*m(type,pkgs)}=={s}: raise ValueError(f"spec: {pkgs} is invalid")                               # noqa
    ge,sys,P,ew=i("os").getenv,i("sys"),i("pathlib").Path,i("sys").stderr.write                             # noqa
    (cache:=(P(ge("XDG_CACHE_HOME",P.home()/".cache"))/"viv"/"venvs")).mkdir(parents=True, exist_ok=True)   # noqa
    ((hash:=i("hashlib").sha256()).update((s(spec)+                                                         # noqa
     (((exe:=s(P(i("sys").executable).resolve()) if track_exe else "N/A")))).encode()))                     # noqa
    if (env:=cache/(name if name else (_id:=hash.hexdigest()))) not in cache.glob("*/") or ge("VIV_FORCE"): # noqa
        v=e(ge("VIV_VERBOSE"));ew(f"generating new vivenv -> {env.name}\n")                                 # noqa
        i("venv").EnvBuilder(with_pip=True,clear=True).create(env)                                          # noqa
        with (env/"pip.conf").open("w") as f:f.write("[global]\ndisable-pip-version-check=true")            # noqa
        if (p:=i("subprocess").run([env/"bin"/"pip","install","--force-reinstall",*spec],text=True,         # noqa
            stdout=(-1,None)[v],stderr=(-2,None)[v])).returncode!=0:                                        # noqa
            if env.is_dir():i("shutil").rmtree(env)                                                         # noqa
            ew(f"pip had non zero exit ({p.returncode})\n{p.stdout}\n");sys.exit(p.returncode)              # noqa
        with (env/"viv-info.json").open("w") as f:                                                          # noqa
            i("json").dump({"created":s(i("datetime").datetime.today()),"id":_id,"spec":spec,"exe":exe},f)  # noqa
    sys.path = [p for p in (*sys.path,s(*(env/"lib").glob("py*/si*"))) if p!=i("site").USER_SITE]           # noqa
_viv_activate("markdown-it-py==2.2.0", "mdurl==0.1.2", "Pygments==2.14.0", "rich==13.3.2")                  # noqa
# fmt: on
# >>>>> code golfed with <3
```

## Alternatives

### [pip-run](https://github.com/jaraco/pip-run)

```sh
pip-run (10.0.5)
├── autocommand (2.2.2)
├── jaraco-context (4.3.0)
├── jaraco-functools (3.6.0)
│   └── more-itertools (9.1.0)
├── jaraco-text (3.11.1)
│   ├── autocommand (2.2.2)
│   ├── inflect (6.0.2)
│   │   └── pydantic>=1.9.1 (1.10.5)
│   │       └── typing-extensions>=4.2.0 (4.5.0)
│   ├── jaraco-context>=4.1 (4.3.0)
│   ├── jaraco-functools (3.6.0)
│   │   └── more-itertools (9.1.0)
│   └── more-itertools (9.1.0)
├── more-itertools>=8.3 (9.1.0)
├── packaging (23.0)
├── path>=15.1 (16.6.0)
├── pip>=19.3 (23.0.1)
└── platformdirs (3.1.0)
```

### [pipx](https://github.com/pypa/pipx/)

```sh
pipx (1.1.0)
├── argcomplete>=1.9.4 (2.1.1)
├── packaging>=20.0 (23.0)
└── userpath>=1.6.0 (1.8.0)
    └── click (8.1.3)
```
